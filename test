-- Vicious Bee Stinger Hunter Script v3.7 - SECURED WITH WEBHOOK TOKEN + WHITELIST
-- Detects "Thorn" parts (Size: 3√ó2√ó1.5) that spawn near fields (ONCE per spawn event)
-- NEW: Whitelist system - Auto marks as NOT ACTIVE after 50 seconds for whitelisted players

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

local request = request or http_request or syn.request
local player = Players.LocalPlayer

local config = {
    WEBHOOK_URL = "https://discord.com/api/webhooks/1456640369801429155/whXmluN3paYc-mMltkKNNJObdzOue1hZvUC72fnCR7x_KTaw4CM2fdSVZZOp6Nvv9ZVu",
    PC_SERVER_URL = "https://antral-contemplatingly-logan.ngrok-free.dev/log",
    WEBHOOK_SECRET = "uupcRwDaCaz0kzxPnibqIbMdNNd1r753oUdS8H8akx8",
    _lastStingerDetectionTime = 0,
    _stingerSpawnCooldown = 2, -- seconds
    _monitoringActive = false,
    playerCountThreshold = 6,
    webhookUrl = "",
    pcServerUrl = "",
    webhookSecret = "",
    isRunning = false,
    stingerDetected = false,
    currentField = "None",
    _descendantConnection = nil,
    _detectedStingers = {},
    detectionCount = 0,
    serverType = "Public",
    privateServerLink = "",
    expectedSize = Vector3.new(3.0, 2.0, 1.5),
    sizeTolerance = 0.1,
    stingerActiveTime = 240,
    _activeStatusTimer = nil,
    _renderConnection = nil  -- ‚Üê ADD THIS LINE
}
config.webhookUrl = config.WEBHOOK_URL
config.pcServerUrl = config.PC_SERVER_URL
config.webhookSecret = config.WEBHOOK_SECRET

-- Load saved webhook
if isfile and readfile and isfile("vicious_bee_webhook.txt") then
    local saved = readfile("vicious_bee_webhook.txt")
    if saved and saved ~= "" then
        config.webhookUrl = saved
        print("‚úÖ Loaded saved webhook")
    end
end

-- Load saved PC server URL
if isfile and readfile and isfile("vicious_bee_pcserver.txt") then
    local saved = readfile("vicious_bee_pcserver.txt")
    if saved and saved ~= "" then
        config.pcServerUrl = saved
        print("‚úÖ Loaded saved PC server URL")
    end
end

-- Load saved webhook secret
if isfile and readfile and isfile("vicious_bee_secret.txt") then
    local saved = readfile("vicious_bee_secret.txt")
    if saved and saved ~= "" then
        config.webhookSecret = saved
        print("‚úÖ Loaded saved webhook secret")
    end
end

-- Load saved server type and private link
if isfile and readfile and isfile("vicious_bee_serverconfig.txt") then
    local success, result = pcall(function()
        local saved = readfile("vicious_bee_serverconfig.txt")
        if saved and saved ~= "" then
            return HttpService:JSONDecode(saved)
        end
    end)
    if success and result then
        config.serverType = result.serverType or "Public"
        config.privateServerLink = result.privateServerLink or ""
        print("‚úÖ Loaded saved server config:", config.serverType)
    end
end

-- ANTI-IDLE SYSTEM
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
    print("üîÑ Anti-idle triggered (idle detection)")
end)

spawn(function()
    while true do
        wait(600)
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
        print("üîÑ Anti-idle triggered (10 min auto)")
    end
end)

local fields = {
    ["Sunflower Field"] = Vector3.new(183, 4, 165),
    ["Mushroom Field"] = Vector3.new(-253, 4, 299),
    ["Dandelion Field"] = Vector3.new(-30, 4, 225),
    ["Blue Flower Field"] = Vector3.new(113, 4, 88),
    ["Clover Field"] = Vector3.new(174, 34, 189),
    ["Strawberry Field"] = Vector3.new(-169, 20, 165),
    ["Spider Field"] = Vector3.new(-57, 20, 4),
    ["Bamboo Field"] = Vector3.new(93, 20, -25),
    ["Pineapple Patch"] = Vector3.new(262, 68, -201),
    ["Pumpkin Patch"] = Vector3.new(-194, 68, -182),
    ["Cactus Field"] = Vector3.new(-194, 68, -107),
    ["Rose Field"] = Vector3.new(-322, 20, 124),
    ["Pine Tree Forest"] = Vector3.new(-318, 68, -150),
    ["Stump Field"] = Vector3.new(439, 96, -179),
    ["Coconut Field"] = Vector3.new(-255, 72, 459),
    ["Pepper Patch"] = Vector3.new(-486, 124, 517),
    ["Mountain Top Field"] = Vector3.new(76, 176, -191)
}

local function sendWebhook(title, description, color, webhookFields)
    if config.webhookUrl == "" then return end
    
    -- üîí WEBHOOK DEBOUNCE: Prevent same webhook within 2 seconds
    local webhookKey = title .. description
    local now = tick()
    
    if not config._lastWebhooks then
        config._lastWebhooks = {}
    end
    
    if config._lastWebhooks[webhookKey] and now - config._lastWebhooks[webhookKey] < 2 then
        print("‚è≠Ô∏è Skipping duplicate webhook:", title)
        return
    end
    
    config._lastWebhooks[webhookKey] = now
    
    local embed = {
        ["title"] = title,
        ["description"] = description,
        ["color"] = color,
        ["fields"] = webhookFields or {},
        ["timestamp"] = DateTime.now():ToIsoDate(),
        ["footer"] = {["text"] = "Vicious Bee Hunter | " .. player.Name}
    }
    
    local success, err = pcall(function()
        request({
            Url = config.webhookUrl,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({["embeds"] = {embed}, ["content"] = "@everyone"})
        })
    end)
    
    if not success then
        warn("Webhook failed:", err)
    end
end

local function getActiveField()
    return config.currentField or "None"
end

local function getClosestField(position)
    local closestField = "Unknown"
    local closestDistance = math.huge
    
    for fieldName, fieldPos in pairs(fields) do
        local dist = (position - fieldPos).Magnitude
        if dist < closestDistance then
            closestDistance = dist
            closestField = fieldName
        end
    end
    
    return closestField, closestDistance
end

local function verifySizeMatch(objSize)
    return math.abs(objSize.X - config.expectedSize.X) <= config.sizeTolerance and
           math.abs(objSize.Y - config.expectedSize.Y) <= config.sizeTolerance and
           math.abs(objSize.Z - config.expectedSize.Z) <= config.sizeTolerance
end

local function generateJoinLink()
    if config.serverType == "Private" and config.privateServerLink ~= "" then
        return config.privateServerLink
    else
        local placeId = game.PlaceId
        local jobId = game.JobId
        return string.format("roblox://experiences/start?placeId=%d&gameInstanceId=%s", placeId, jobId)
    end
end

local function getPlayerCount()
    return #Players:GetPlayers()
end

local function updateStingerLog(playerName, field, status, joinLink)
    -- üîí PC SERVER DEBOUNCE (prevents duplicate ngrok requests)
    config._lastLogSend = config._lastLogSend or {}
    local key = playerName .. "|" .. field .. "|" .. status
    local now = os.time()

    if config._lastLogSend[key] and now - config._lastLogSend[key] < 2 then
        print("‚è≠Ô∏è Skipping duplicate PC log:", key)
        return
    end

    config._lastLogSend[key] = now
    if config.pcServerUrl ~= "" then
        local logData = {
            player = playerName,
            field = field,
            status = status,
            timestamp = os.time(),
            detectionTime = os.time(),
            serverLink = joinLink or "N/A"
        }
        
        local success, err = pcall(function()
            request({
                Url = config.pcServerUrl,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json",
                    ["X-Webhook-Token"] = config.webhookSecret
                },
                Body = HttpService:JSONEncode(logData)
            })
        end)
        
        if success then
            print("‚úÖ Log sent to PC server (SECURE):", playerName, "-", field, "-", status)
        else
            warn("‚ùå Failed to send log to PC:", err)
        end
    end
    
    if not writefile or not readfile or not isfile then
        return
    end
    
    local logData = {}
    
    if isfile("vicious_bee_stinger_log.txt") then
        local success, result = pcall(function()
            local content = readfile("vicious_bee_stinger_log.txt")
            if content and content ~= "" then
                return HttpService:JSONDecode(content)
            end
        end)
        if success and result then
            logData = result
        end
    end
    
    local timestamp = os.time()
    logData[playerName] = {
        Field = field,
        Status = status,
        LastUpdate = timestamp,
        DetectionTime = logData[playerName] and logData[playerName].DetectionTime or timestamp,
        ServerLink = joinLink or "N/A"
    }
    
    pcall(function()
        writefile("vicious_bee_stinger_log.txt", HttpService:JSONEncode(logData, true))
    end)
end

local function formatLogToReadable()
    if not readfile or not isfile or not isfile("vicious_bee_stinger_log.txt") then
        return "No log file found"
    end
    
    local success, logData = pcall(function()
        local content = readfile("vicious_bee_stinger_log.txt")
        if content and content ~= "" then
            return HttpService:JSONDecode(content)
        end
    end)
    
    if not success or not logData then
        return "Failed to read log file"
    end
    
    local output = "=== VICIOUS BEE STINGER LOG ===\n\n"
    local currentTime = os.time()
    
    for playerName, data in pairs(logData) do
        output = output .. "Player: " .. playerName .. "\n"
        output = output .. "Field: " .. data.Field .. "\n"
        
        local timeSinceDetection = currentTime - (data.DetectionTime or 0)
        local status = (timeSinceDetection < config.stingerActiveTime) and "ACTIVE" or "NOT ACTIVE"
        
        output = output .. "Status: " .. status .. "\n"
        
        if status == "ACTIVE" then
            local remainingTime = config.stingerActiveTime - timeSinceDetection
            output = output .. "Time Remaining: " .. math.floor(remainingTime / 60) .. "m " .. (remainingTime % 60) .. "s\n"
        end
        
        output = output .. "Server Link: " .. (data.ServerLink or "N/A") .. "\n"
        output = output .. "\n"
    end
    
    return output
end

-- Auto-update status every 30 seconds
spawn(function()
    while true do
        wait(30)
        if readfile and isfile and writefile and isfile("vicious_bee_stinger_log.txt") then
            local success, logData = pcall(function()
                local content = readfile("vicious_bee_stinger_log.txt")
                if content and content ~= "" then
                    return HttpService:JSONDecode(content)
                end
            end)
            
            if success and logData then
                local currentTime = os.time()
                local updated = false
                
                for playerName, data in pairs(logData) do
                    local timeSinceDetection = currentTime - (data.DetectionTime or 0)
                    local newStatus = (timeSinceDetection < config.stingerActiveTime) and "ACTIVE" or "NOT ACTIVE"
                    
                    if data.Status ~= newStatus then
                        data.Status = newStatus
                        data.LastUpdate = currentTime
                        updated = true
                    end
                end
                
                if updated then
                    pcall(function()
                        writefile("vicious_bee_stinger_log.txt", HttpService:JSONEncode(logData, true))
                        print("üîÑ Stinger log statuses updated")
                    end)
                end
            end
        end
    end
end)

local function startPlayerCountMonitoring(field, joinLink)
    config._monitoringSessionId = tick()
    local sessionId = config._monitoringSessionId
    -- üîß ENHANCED CLEANUP: Stop any existing monitoring COMPLETELY
    print("üîÑ Starting fresh player count monitoring...")
    
    -- Force stop monitoring flag
    config._monitoringActive = false
    
    -- Disconnect PlayerAdded connection
    if config._playerMonitorConnection then
        pcall(function()
            config._playerMonitorConnection:Disconnect()
        end)
        config._playerMonitorConnection = nil
        print("‚úÖ Cleared old PlayerAdded connection")
    end
    
    -- Disconnect PlayerRemoving connection
    if config._playerRemovingConnection then
        pcall(function()
            config._playerRemovingConnection:Disconnect()
        end)
        config._playerRemovingConnection = nil
        print("‚úÖ Cleared old PlayerRemoving connection")
    end
    
    -- Cancel 4-minute timer
    if config._activeStatusTimer then
        pcall(function()
            task.cancel(config._activeStatusTimer)
        end)
        config._activeStatusTimer = nil
        print("‚úÖ Cleared old 4-minute timer")
    end
    
    -- Small delay to ensure cleanup completes
    task.wait(0.1)
    
    config._monitoringActive = true
    local monitorStartTime = tick()
    local lastPlayerCount = getPlayerCount()
    local lastStatus = lastPlayerCount < config.playerCountThreshold and "ACTIVE" or "NOT ACTIVE"
    
    -- Set initial status based on player count
    updateStingerLog(player.Name, getActiveField(), lastStatus, joinLink)
    print(string.format("üë• Initial player count: %d - Status: %s", lastPlayerCount, lastStatus))
    
    -- Monitor player joins/leaves
    local function onPlayerCountChange()
        if sessionId ~= config._monitoringSessionId then return end
    task.wait() -- first yield

    if not config._monitoringActive then
        return
    end

    task.wait() -- üîß ADD THIS SECOND YIELD

    if not config._monitoringActive then
        return
    end
    
    local currentPlayerCount = getPlayerCount()
        local newStatus = currentPlayerCount < config.playerCountThreshold and "ACTIVE" or "NOT ACTIVE"

        
        -- Only update if status changed
        if newStatus ~= lastStatus then
            updateStingerLog(player.Name, getActiveField(), newStatus, joinLink)
            
            local changeType = currentPlayerCount > lastPlayerCount and "joined" or "left"
            print(string.format("üë• Player %s! Count: %d ‚Üí Status changed to: %s", changeType, currentPlayerCount, newStatus))
            
            sendWebhook(
                "üë• Player Count Changed",
                string.format("Player count changed from **%d** to **%d**\n\nStatus updated to: **%s**", lastPlayerCount, currentPlayerCount, newStatus),
                newStatus == "ACTIVE" and 0x00FF00 or 0xFF5252,
                {
                    { name = "üìä Player Count", value = tostring(currentPlayerCount), inline = true },
                    { name = "üìä Status", value = newStatus, inline = true },
                    { name = "üìç Field", value = getActiveField(), inline = true },
                    { name = "ü§ñ Bot", value = player.Name, inline = true }
                }
            )
            
            lastStatus = newStatus
        end
        
        lastPlayerCount = currentPlayerCount
    end
    
    -- Connect to player events WITH DEBOUNCE
    config._playerMonitorConnection = Players.PlayerAdded:Connect(function()
        task.delay(0.5, onPlayerCountChange) -- Delay to batch rapid joins
    end)
    
    -- üîß STORE THIS CONNECTION GLOBALLY (NOT LOCAL!)
    config._playerRemovingConnection = Players.PlayerRemoving:Connect(function()
        task.delay(0.5, onPlayerCountChange) -- Delay to batch rapid leaves
    end)
    
    -- 4-minute timer
config._activeStatusTimer = task.delay(config.stingerActiveTime, function()
    if sessionId ~= config._monitoringSessionId then return end
    print("‚è∞ 4-minute monitoring window ended")
    
    if not config._monitoringActive then
        return
    end
    
    -- Stop monitoring completely
    config._monitoringActive = false
    
    -- üîß DISCONNECT BOTH CONNECTIONS (was missing _playerRemovingConnection)
    if config._playerMonitorConnection then
        pcall(function()
            config._playerMonitorConnection:Disconnect()
        end)
        config._playerMonitorConnection = nil
    end
    
    if config._playerRemovingConnection then  -- ‚Üê ADD THIS ENTIRE BLOCK
        pcall(function()
            config._playerRemovingConnection:Disconnect()
        end)
        config._playerRemovingConnection = nil
    end
    
    -- Set final status to NOT ACTIVE
    updateStingerLog(player.Name, getActiveField(), "NOT ACTIVE", joinLink)
    
    sendWebhook(
        "‚è∞ Monitoring Period Ended",
        "4-minute window has expired.\n\nStatus set to: **NOT ACTIVE**",
        0xFFA500,
        {
            { name = "üìç Field", value = getActiveField(), inline = true },
            { name = "ü§ñ Bot", value = player.Name, inline = true },
            { name = "‚è±Ô∏è Duration", value = "4 minutes", inline = true }
        }
    )
end)
    
    sendWebhook(
        "üéØ Player Count Monitoring Started",
        string.format("Monitoring player count for **4 minutes**\n\nCurrent players: **%d**\nThreshold: **%d players**\nInitial status: **%s**", lastPlayerCount, config.playerCountThreshold, lastStatus),
        0x2196F3,
        {
            { name = "üìä Current Players", value = tostring(lastPlayerCount), inline = true },
            { name = "üìä Threshold", value = tostring(config.playerCountThreshold), inline = true },
            { name = "üìä Initial Status", value = lastStatus, inline = true },
            { name = "üìç Field", value = getActiveField(), inline = true },
            { name = "‚è±Ô∏è Duration", value = "4 minutes", inline = true }
        }
    )
end

-- SMART DETECTION: Only alert ONCE per spawn event with size verification
local function onNewObject(obj)
    if config.stingerDetected then
        return
    end

    local now = tick()
    if now - config._lastStingerDetectionTime < config._stingerSpawnCooldown then
        return
    end

    if not config.isRunning then return end

    task.wait(0.05)

    if not obj or not obj.Parent then return end
    if not obj:IsA("BasePart") then return end
    
    if obj.Name ~= "Thorn" then return end
    
    if not verifySizeMatch(obj.Size) then
        print("‚ö†Ô∏è Ignored 'Thorn' with wrong size:", string.format("%.2f√ó%.2f√ó%.2f", obj.Size.X, obj.Size.Y, obj.Size.Z))
        return
    end

    local field, distance = getClosestField(obj.Position)

    if field == "Unknown" or distance > 150 then
        return
    end

    -- per-object dedupe
    if config._detectedStingers[obj] then return end
    config._detectedStingers[obj] = true

    config.stingerDetected = true
    config._defeatReported = false
    config._lastStingerDetectionTime = now
    config.currentField = field
    config.detectionCount = config.detectionCount + 1

    local joinLink = generateJoinLink()
    local serverTypeText = config.serverType == "Private" and "üîí Private Server" or "üåê Public Server"
    
    -- Start player count monitoring for 4 minutes
    startPlayerCountMonitoring(field, joinLink)
    
    local playerDistance = "Unknown"
    local char = player.Character
    if char then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            playerDistance = math.floor((hrp.Position - obj.Position).Magnitude) .. " studs"
        end
    end

    local currentPlayerCount = getPlayerCount()
    local webhookFields = {
        { name = "üì¶ Object Name", value = obj.Name, inline = true },
        { name = "üîß Type", value = obj.ClassName, inline = true },
        { name = "üìç Field", value = config.currentField, inline = true },
        { name = "üìè Field Distance", value = math.floor(distance) .. " studs", inline = true },
        { name = "üë§ Player Distance", value = playerDistance, inline = true },
        { name = "üñ•Ô∏è Server Type", value = serverTypeText, inline = true },
        { name = "üìê Size", value = string.format("%.1f√ó%.1f√ó%.1f", obj.Size.X, obj.Size.Y, obj.Size.Z), inline = true },
        { name = "‚úÖ Size Verified", value = "Matches stinger (3√ó2√ó1.5)", inline = true },
        { name = "üß≠ Position", value = string.format("(%.1f, %.1f, %.1f)", obj.Position.X, obj.Position.Y, obj.Position.Z), inline = false },
        { name = "üî¢ Detection #", value = tostring(config.detectionCount), inline = true }
    }
    
    sendWebhook(
    "üéØ VICIOUS BEE STINGER DETECTED!",
    "üö® A stinger was found!\n\n**üîó [CLICK HERE TO JOIN THIS SERVER](" .. joinLink .. ")**\n\n**üë• Player Count Monitoring: ACTIVE (4 minutes)**",
    0xFF0000,
    webhookFields
    )

    print("üéØ VICIOUS BEE STINGER DETECTED!")
    print("üìç Field:", config.currentField)
    print("üìè Distance from field:", math.floor(distance), "studs")
    print("üìê Size:", string.format("%.1f√ó%.1f√ó%.1f", obj.Size.X, obj.Size.Y, obj.Size.Z))
    print("‚úÖ Size verified: Matches stinger dimensions")
    print("üñ•Ô∏è Server Type:", serverTypeText)
    print("üîó Join Link:", joinLink)
    print("üî¢ Detection count:", config.detectionCount)
    print("üîê Log sent with webhook secret token")

    obj.AncestryChanged:Connect(function()
        if not obj.Parent then
            -- üîí Per-object dedupe
            if config._detectedStingers[obj] == "defeated" then
                return
            end
    
            -- üîí Global dedupe
            if config._defeatReported then
                return
            end
    
            config._defeatReported = true
            config._detectedStingers[obj] = "defeated"
    
            print("‚ö†Ô∏è Stinger removed from workspace")
    
            config.stingerDetected = false
    
            local joinLink = generateJoinLink()
    
            local defeatedField = getActiveField()

            updateStingerLog(player.Name, defeatedField, "NOT ACTIVE", joinLink)
            
            -- Reset AFTER sending
            config.currentField = "None"
    
            sendWebhook(
                "üèÜ Vicious Bee Defeated!",
                "The stinger at **"..defeatedField.."** has been removed from the workspace!\n\nStatus set to **NOT ACTIVE**",
                0x00FF00,
                {
                    { name = "ü§ñ Bot", value = player.Name, inline = true },
                    { name = "üìç Field", value = defeatedField, inline = true },
                    { name = "üîó Join Link", value = joinLink, inline = false },
                    { name = "‚è±Ô∏è Time", value = os.date("%X"), inline = true }
                }
            )
    
            -- üîπ Stop monitoring
            config._defeatCheckActive = false
            if config._monitoringActive then
                print("üõë Stopping player monitoring (stinger defeated)...")
                config._monitoringActive = false
                
                -- Disconnect PlayerAdded
                if config._playerMonitorConnection then
                    pcall(function() 
                        config._playerMonitorConnection:Disconnect() 
                    end)
                    config._playerMonitorConnection = nil
                    print("‚úÖ Disconnected PlayerAdded")
                end
                
                -- Disconnect PlayerRemoving
                if config._playerRemovingConnection then
                    pcall(function() 
                        config._playerRemovingConnection:Disconnect() 
                    end)
                    config._playerRemovingConnection = nil
                    print("‚úÖ Disconnected PlayerRemoving")
                end
                
                -- Cancel 4-minute timer
                if config._activeStatusTimer then
                    pcall(function()
                        task.cancel(config._activeStatusTimer)
                    end)
                    config._activeStatusTimer = nil
                    print("‚úÖ Cancelled 4-minute timer")
                end
                    
                print("üõë Player monitoring stopped (stinger defeated)")
            end
        end
    end)
end

local function createGUI()
    if CoreGui:FindFirstChild("ViciousBeeHunterGUI") then
        CoreGui:FindFirstChild("ViciousBeeHunterGUI"):Destroy()
    end
    
    local ScreenGui = Instance.new("ScreenGui")
    local MainFrame = Instance.new("Frame")
    local Title = Instance.new("TextLabel")
    local CloseButton = Instance.new("TextButton")
    
    -- Control buttons
    local StartButton = Instance.new("TextButton")
    local ViewLogButton = Instance.new("TextButton")
    
    -- Server type buttons
    local PublicButton = Instance.new("TextButton")
    local PrivateButton = Instance.new("TextButton")
    local PrivateServerBox = Instance.new("TextBox")
    
    -- Info labels
    local StatusLabel = Instance.new("TextLabel")
    local FieldLabel = Instance.new("TextLabel")
    local PlayerCountLabel = Instance.new("TextLabel")
    local DetectionCountLabel = Instance.new("TextLabel")
    local PositionLabel = Instance.new("TextLabel")
    local AntiIdleLabel = Instance.new("TextLabel")
    local InfoLabel = Instance.new("TextLabel")
    
    ScreenGui.Name = "ViciousBeeHunterGUI"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    -- COMPACT FRAME: 500 wide x 380 tall
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -250, 0.5, -190)
    MainFrame.Size = UDim2.new(0, 500, 0, 300)
    MainFrame.Active = true
    MainFrame.Draggable = true
    
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 12)
    
    -- Title bar
    Title.Parent = MainFrame
    Title.BackgroundColor3 = Color3.fromRGB(255, 200, 50)
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.Font = Enum.Font.GothamBold
    Title.Text = "üêù Vicious Bee Detector v3.8 Compact"
    Title.TextColor3 = Color3.fromRGB(20, 20, 20)
    Title.TextSize = 16
    
    Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 12)
    
    CloseButton.Parent = MainFrame
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
    end)

    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    CloseButton.Position = UDim2.new(1, -32, 0, 8)
    CloseButton.Size = UDim2.new(0, 24, 0, 24)
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 14
    
    Instance.new("UICorner", CloseButton)
    
    -- ROW 2: CONTROLS & INFO
    -- Left side: Start button
    StartButton.Parent = MainFrame
    StartButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    StartButton.Position = UDim2.new(0, 10, 0, 50)
    StartButton.Size = UDim2.new(0.3, -10, 0, 38)
    StartButton.Font = Enum.Font.GothamBold
    StartButton.Text = "START"
    StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    StartButton.TextSize = 14
    
    Instance.new("UICorner", StartButton).CornerRadius = UDim.new(0, 8)
    
    -- Middle: View Log
    ViewLogButton.Parent = MainFrame
    ViewLogButton.BackgroundColor3 = Color3.fromRGB(255, 150, 50)
    ViewLogButton.Position = UDim2.new(0.33, 0, 0, 50)
    ViewLogButton.Size = UDim2.new(0.3, -10, 0, 38)
    ViewLogButton.Font = Enum.Font.GothamBold
    ViewLogButton.Text = "üìã LOG"
    ViewLogButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ViewLogButton.TextSize = 13
    
    Instance.new("UICorner", ViewLogButton).CornerRadius = UDim.new(0, 8)
    
    -- Right side: Server type buttons stacked
    PublicButton.Parent = MainFrame
    PublicButton.BackgroundColor3 = config.serverType == "Public" and Color3.fromRGB(50, 150, 255) or Color3.fromRGB(60, 60, 65)
    PublicButton.Position = UDim2.new(0.66, 5, 0, 50)
    PublicButton.Size = UDim2.new(0.34, -15, 0, 17)
    PublicButton.Font = Enum.Font.GothamBold
    PublicButton.Text = "üåê Public"
    PublicButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    PublicButton.TextSize = 11
    
    Instance.new("UICorner", PublicButton).CornerRadius = UDim.new(0, 6)
    
    PrivateButton.Parent = MainFrame
    PrivateButton.BackgroundColor3 = config.serverType == "Private" and Color3.fromRGB(50, 150, 255) or Color3.fromRGB(60, 60, 65)
    PrivateButton.Position = UDim2.new(0.66, 5, 0, 71)
    PrivateButton.Size = UDim2.new(0.34, -15, 0, 17)
    PrivateButton.Font = Enum.Font.GothamBold
    PrivateButton.Text = "üîí Private"
    PrivateButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    PrivateButton.TextSize = 11
    
    Instance.new("UICorner", PrivateButton).CornerRadius = UDim.new(0, 6)
    
    -- Private server link box (below server buttons)
    PrivateServerBox.Parent = MainFrame
    PrivateServerBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    PrivateServerBox.Position = UDim2.new(0, 10, 0, 172)
    PrivateServerBox.Size = UDim2.new(1, -20, 0, 28)
    PrivateServerBox.Font = Enum.Font.Gotham
    PrivateServerBox.PlaceholderText = "Private Server Link..."
    PrivateServerBox.Text = config.privateServerLink
    PrivateServerBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    PrivateServerBox.TextSize = 11
    PrivateServerBox.ClearTextOnFocus = false
    PrivateServerBox.Visible = config.serverType == "Private"
    
    Instance.new("UICorner", PrivateServerBox).CornerRadius = UDim.new(0, 8)
    
    -- INFO SECTION (Compact 2-column grid layout)
    local infoStartY = 135
    
    StatusLabel.Parent = MainFrame
    StatusLabel.Name = "StatusLabel"
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Position = UDim2.new(0, 10, 0, infoStartY)
    StatusLabel.Size = UDim2.new(0.5, -10, 0, 18)
    StatusLabel.Font = Enum.Font.GothamBold
    StatusLabel.Text = "Status: Idle"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.TextSize = 11
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    PlayerCountLabel.Parent = MainFrame
    PlayerCountLabel.Name = "PlayerCountLabel"
    PlayerCountLabel.BackgroundTransparency = 1
    PlayerCountLabel.Position = UDim2.new(0.5, 0, 0, infoStartY)
    PlayerCountLabel.Size = UDim2.new(0.5, -10, 0, 18)
    PlayerCountLabel.Font = Enum.Font.Gotham
    PlayerCountLabel.Text = "üë• Players: " .. getPlayerCount()
    PlayerCountLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    PlayerCountLabel.TextSize = 11
    PlayerCountLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    FieldLabel.Parent = MainFrame
    FieldLabel.Name = "FieldLabel"
    FieldLabel.BackgroundTransparency = 1
    FieldLabel.Position = UDim2.new(0, 10, 0, infoStartY + 22)
    FieldLabel.Size = UDim2.new(0.5, -10, 0, 18)
    FieldLabel.Font = Enum.Font.Gotham
    FieldLabel.Text = "Field: Waiting..."
    FieldLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    FieldLabel.TextSize = 11
    FieldLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    DetectionCountLabel.Parent = MainFrame
    DetectionCountLabel.Name = "DetectionCountLabel"
    DetectionCountLabel.BackgroundTransparency = 1
    DetectionCountLabel.Position = UDim2.new(0.5, 0, 0, infoStartY + 22)
    DetectionCountLabel.Size = UDim2.new(0.5, -10, 0, 18)
    DetectionCountLabel.Font = Enum.Font.Gotham
    DetectionCountLabel.Text = "Detections: 0"
    DetectionCountLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    DetectionCountLabel.TextSize = 11
    DetectionCountLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    PositionLabel.Parent = MainFrame
    PositionLabel.Name = "PositionLabel"
    PositionLabel.BackgroundTransparency = 1
    PositionLabel.Position = UDim2.new(0, 10, 0, infoStartY + 44)
    PositionLabel.Size = UDim2.new(1, -20, 0, 18)
    PositionLabel.Font = Enum.Font.Gotham
    PositionLabel.Text = "Position: Waiting..."
    PositionLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    PositionLabel.TextSize = 11
    PositionLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    AntiIdleLabel.Parent = MainFrame
    AntiIdleLabel.Name = "AntiIdleLabel"
    AntiIdleLabel.BackgroundTransparency = 1
    AntiIdleLabel.Position = UDim2.new(0, 10, 0, infoStartY + 66)
    AntiIdleLabel.Size = UDim2.new(0.5, -10, 0, 18)
    AntiIdleLabel.Font = Enum.Font.Gotham
    AntiIdleLabel.Text = "üîÑ Anti-Idle: Active"
    AntiIdleLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    AntiIdleLabel.TextSize = 11
    AntiIdleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    InfoLabel.Parent = MainFrame
    InfoLabel.BackgroundTransparency = 1
    InfoLabel.Position = UDim2.new(0.5, 0, 0, infoStartY + 66)
    InfoLabel.Size = UDim2.new(0.5, -10, 0, 18)
    InfoLabel.Font = Enum.Font.Gotham
    InfoLabel.Text = "üîê Secured"
    InfoLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    InfoLabel.TextSize = 10
    InfoLabel.TextWrapped = true
    InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Config indicator at bottom
    local ConfigLabel = Instance.new("TextLabel")
    ConfigLabel.Parent = MainFrame
    ConfigLabel.BackgroundTransparency = 1
    ConfigLabel.Position = UDim2.new(0, 10, 0, infoStartY + 88)
    ConfigLabel.Size = UDim2.new(1, -20, 0, 15)
    ConfigLabel.Font = Enum.Font.Gotham
    ConfigLabel.Text = "‚öôÔ∏è Hardcoded Config (Edit script to change webhook/secret)"
    ConfigLabel.TextColor3 = Color3.fromRGB(120, 120, 120)
    ConfigLabel.TextSize = 9
    ConfigLabel.TextXAlignment = Enum.TextXAlignment.Center
    
    -- Button handlers
    PublicButton.MouseButton1Click:Connect(function()
        config.serverType = "Public"
        PublicButton.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
        PrivateButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        PrivateServerBox.Visible = false
        
        if writefile then
            writefile("vicious_bee_serverconfig.txt", HttpService:JSONEncode({
                serverType = config.serverType,
                privateServerLink = config.privateServerLink
            }))
            print("‚úÖ Server type set to Public")
        end
    end)
    
    PrivateButton.MouseButton1Click:Connect(function()
        config.serverType = "Private"
        PrivateButton.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
        PublicButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        PrivateServerBox.Visible = true
        
        if writefile then
            writefile("vicious_bee_serverconfig.txt", HttpService:JSONEncode({
                serverType = config.serverType,
                privateServerLink = config.privateServerLink
            }))
            print("‚úÖ Server type set to Private")
        end
    end)
    
    PrivateServerBox.FocusLost:Connect(function()
        config.privateServerLink = PrivateServerBox.Text
        if writefile then
            writefile("vicious_bee_serverconfig.txt", HttpService:JSONEncode({
                serverType = config.serverType,
                privateServerLink = config.privateServerLink
            }))
            print("‚úÖ Private server link saved")
        end
    end)
    
    StartButton.MouseButton1Click:Connect(function()
        if not config.isRunning then
            -- START
            config.isRunning = true
            StartButton.Text = "STOP"
            StartButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
            StatusLabel.Text = "Status: üü¢ Running"
            StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    
            if not config._descendantConnection then
                config._descendantConnection = Workspace.DescendantAdded:Connect(onNewObject)
            end
    
            -- üîî SEND START WEBHOOK
            sendWebhook(
                "üöÄ Detection Started",
                "Vicious Bee detection has been started.\n\nBot: **" .. player.Name .. "**",
                0x00BFFF,
                {
                    { name = "ü§ñ Bot", value = player.Name, inline = true },
                    { name = "üñ•Ô∏è Server Type", value = config.serverType, inline = true },
                    { name = "üìç Status", value = "Running", inline = true }
                }
            )
    
        else
            -- STOP
            config.isRunning = false
            StartButton.Text = "START"
            StartButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
            StatusLabel.Text = "Status: ‚õî Stopped"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end)
end

print("üêù Vicious Bee Stinger Detector v3.8 Loaded!")
print("üì± Opening GUI...")
print("üéØ This script detects 'Thorn' parts (Size: 3√ó2√ó1.5) spawning near fields!")
print("üîÑ Anti-idle system enabled!")
print("üñ•Ô∏è Server Type:", config.serverType)
print("‚úÖ Size verification active: Only detects stingers with exact size 3.0√ó2.0√ó1.5")
print("üîê SECURITY: Webhook secret token system enabled!")
print("‚ö†Ô∏è IMPORTANT: Set your webhook secret token before starting!")
createGUI()
